name: Build and Release IPK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

env:
  OPENWRT_VERSION: "24.10.3"
  FEEDS_CONF: |
    src-git packages https://git.openwrt.org/feed/packages.git^openwrt-24.10
    src-git luci https://git.openwrt.org/project/luci.git^openwrt-24.10
    src-git routing https://git.openwrt.org/feed/routing.git^openwrt-24.10
    src-git telephony https://git.openwrt.org/feed/telephony.git^openwrt-24.10

jobs:
  build:
    name: Build IPK for ${{ matrix.target }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - arch: "x86_64"
            sdk_url_path: "x86/64"
          - arch: "aarch64_generic"
            sdk_url_path: "armsr/armv8"
          - arch: "arm_cortex-a9"
            sdk_url_path: "bcm27xx/bcm2709"
          - arch: "mips_24kc"
            sdk_url_path: "ath79/generic"
          - arch: "mipsel_24kc"
            sdk_url_path: "ramips/mt7621"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5-dev libncursesw5-dev \
            zlib1g-dev gawk git gettext libssl-dev xsltproc rsync wget unzip python3 zstd
          
      - name: Download OpenWrt SDK
        run: |
          SDK_PATH_FORMATTED=$(echo "${{ matrix.target.sdk_url_path }}" | sed 's|/|-|g')
          SDK_URL="https://downloads.openwrt.org/releases/${{ env.OPENWRT_VERSION }}/targets/${{ matrix.target.sdk_url_path }}/openwrt-sdk-${{ env.OPENWRT_VERSION }}-${SDK_PATH_FORMATTED}_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
          echo "Downloading SDK from: $SDK_URL"
          wget -O sdk.tar.zst "$SDK_URL"
          tar --zstd -xf sdk.tar.zst
          mv openwrt-sdk-* openwrt-sdk
          
      - name: Setup Feeds
        run: |
          cd openwrt-sdk
          echo "${{ env.FEEDS_CONF }}" > feeds.conf
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
      - name: Copy Package to SDK
        run: |
          mkdir -p openwrt-sdk/package/luci-app-fuck-pcdn
          cp -r * openwrt-sdk/package/luci-app-fuck-pcdn/ || true
          rm -rf openwrt-sdk/package/luci-app-fuck-pcdn/.git
          rm -rf openwrt-sdk/package/luci-app-fuck-pcdn/.github
          
      - name: Configure Build
        run: |
          cd openwrt-sdk
          make defconfig
          echo "CONFIG_PACKAGE_luci-app-fuck-pcdn=m" >> .config
          make defconfig
          
      - name: Build Package
        run: |
          cd openwrt-sdk
          make package/luci-app-fuck-pcdn/compile V=s
          
      - name: Find and Prepare IPK
        run: |
          cd openwrt-sdk
          find bin/ -name "luci-app-fuck-pcdn*.ipk" -exec cp {} ../luci-app-fuck-pcdn_${{ matrix.target.arch }}.ipk \;
          ls -la ../luci-app-fuck-pcdn_${{ matrix.target.arch }}.ipk
          
      - name: Upload IPK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-fuck-pcdn-${{ matrix.target.arch }}
          path: luci-app-fuck-pcdn_${{ matrix.target.arch }}.ipk

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Prepare Release Files
        run: |
          mkdir -p release
          find artifacts -name "*.ipk" -exec cp {} release/ \;
          ls -la release/
          
          # Create checksums
          cd release
          sha256sum *.ipk > SHA256SUMS
          cd ..
          
      - name: Get Release Tag
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
          
      - name: Generate Release Notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## LuCI App Fuck PCDN ${{ steps.get_tag.outputs.tag }}
          
          ### åŠŸèƒ½ç‰¹æ€§
          - ðŸš« å±è”½ä¸»æµè§†é¢‘å’ŒéŸ³ä¹å¹³å°çš„ PCDN åŸŸå
          - ðŸŽµ æ”¯æŒ QQéŸ³ä¹ã€è…¾è®¯è§†é¢‘ã€çˆ±å¥‡è‰ºã€ä¼˜é…·ã€Bilibili
          - ðŸŒ æ”¯æŒè¿œç¨‹ JSON API èŽ·å–åŸŸååˆ—è¡¨
          - ðŸ”§ ç®€æ´çš„ LuCI Web ç•Œé¢
          - ðŸ”„ è‡ªåŠ¨å¤‡ä»½å’Œæ¢å¤åŠŸèƒ½
          
          ### æ”¯æŒçš„æž¶æž„
          - x86_64 (é€‚ç”¨äºŽ x86 64ä½è®¾å¤‡)
          - aarch64_generic (é€‚ç”¨äºŽ ARM64 è®¾å¤‡)
          - arm_cortex-a9 (é€‚ç”¨äºŽæ ‘èŽ“æ´¾ç­‰ ARM è®¾å¤‡)
          - mips_24kc (é€‚ç”¨äºŽ ath79 å¹³å°è·¯ç”±å™¨)
          - mipsel_24kc (é€‚ç”¨äºŽ ramips å¹³å°è·¯ç”±å™¨)
          
          ### å®‰è£…æ–¹æ³•
          1. ä¸‹è½½å¯¹åº”æž¶æž„çš„ IPK æ–‡ä»¶
          2. ä¸Šä¼ åˆ°è·¯ç”±å™¨: `scp luci-app-fuck-pcdn_*.ipk root@192.168.1.1:/tmp/`
          3. å®‰è£…è½¯ä»¶åŒ…: `opkg install /tmp/luci-app-fuck-pcdn_*.ipk`
          4. é‡å¯æœåŠ¡: `/etc/init.d/rpcd restart && /etc/init.d/uhttpd restart`
          
          ### ä½¿ç”¨è¯´æ˜Ž
          1. ç™»å½• LuCI ç®¡ç†ç•Œé¢
          2. å¯¼èˆªåˆ° "æœåŠ¡" â†’ "PCDNå±è”½å™¨"
          3. å¯ç”¨æ’ä»¶å¹¶é€‰æ‹©è¦å±è”½çš„å¹³å°
          4. ç‚¹å‡»"ä¿å­˜&åº”ç”¨"
          
          ### æ–‡ä»¶æ ¡éªŒ
          è¯·ä½¿ç”¨ SHA256SUMS æ–‡ä»¶éªŒè¯ä¸‹è½½æ–‡ä»¶çš„å®Œæ•´æ€§ï¼š
          ```bash
          sha256sum -c SHA256SUMS
          ```
          EOF
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_tag.outputs.tag }}
          name: LuCI App Fuck PCDN ${{ steps.get_tag.outputs.tag }}
          body_path: release_notes.md
          files: |
            release/*.ipk
            release/SHA256SUMS
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}